# WAVE 语音播报收口状态（2026-02-16）

## 1. 本轮修复目标（用户现场反馈）
- Speech 设置面板结构松散，不好理解。
- 测试朗读入口缺失/不可用，导致无法快速验证“到底是配置不对还是播放链路坏了”。
- 面板右上角朗读按钮出现“灰色点不动/没反应”，体验差。
- 切换来源/引擎后，人物（voice）下拉列表与当前引擎不匹配，选择看起来不生效。

## 2. 已完成（代码已合并）

### A. Speech 设置面板重构
- WaveConfig 左侧 `Speech` 页已重新按区块收拢：
  - `测试朗读`：文本输入 + 角色选择 + 播放/停止 + 当前将使用的 transport/model/endpoint/voice 信息。
  - `总开关` / `播报模式`：自动播报与手动按钮开关。
  - `语音来源`：local / OpenAI 兼容 API。
  - `API 设置`：仅在 API 模式显示（Endpoint + 模型下拉）。
  - `本地服务 Endpoint`：仅在 local+edge/melo 显示，并提供“默认”按钮（清空后使用默认端口）。
  - `本地模型（Melo）`：仅在 local+melo 显示（目录/扫描/模型名）。
  - `角色人物`：assistant / user / system 独立下拉。
  - `播报过滤`：URL/路径/代码过滤开关。

### B. 朗读按钮“灰色点不动”修复
- AI 面板头部朗读按钮不再因为“无文本/关闭开关”而直接禁用：
  - 点击后会给出明确错误提示（例如：无可朗读文本、Speech 已关闭、Endpoint 未配置等）。
- 窗口头部（齿轮左侧）朗读按钮同样不再被禁用，避免“点不动=坏了”的误判。

### C. 不同 AI CLI 的朗读（终端块）
- 在终端块点击朗读按钮时，会优先读取“上一条命令输出（last command）”并播报。
- 如果 shell integration 不可用或取 last command 失败，会直接提示错误（不再回退读最近 200 行，以避免误读历史噪声）。
- 这样 `codex / claude / gemini / amp / iflow / opencode / clawx` 等终端 AI CLI 的输出仍可朗读，但前提是能取到该命令的输出。

### D. 仅朗读“最终回复”（避免半截内容）
- 当 AI 正在生成（streaming）时，手动朗读会提示“请等回复完成后再朗读”，避免读到半截文本。

### E. Voice 下拉联动修复
- 人物（voice）下拉现在严格展示“当前来源/引擎支持”的 voice 列表。
- 当切换来源/引擎导致当前选择的 voice 不受支持时，会自动回退到可用的默认 voice。
- 浏览器语音（speechSynthesis）列表中保留 `system-default` 选项。

### F. 汉化补漏（Shell Extensions 安装提示）
- WSH 安装确认弹窗已补齐中文：标题、正文、确认/取消按钮文案。

## 3. 打包产物
- 已通过：`task package`（零错误）。
- 最新安装包：`make/WAVE-win32-x64-0.14.0-1.exe`
- 已更新桌面投放：`D:\DESK\WAVE-setup-latest.exe`

## 4. 建议测试清单（你用新版自测）
- WaveConfig -> Speech：
  - 先用 `测试朗读` 播放，确认能发声。
  - 切换 local/api、edge/melo/browser，观察 voice 下拉是否联动变化。
  - 切换 voice 后再次测试播放，确认选择生效。
  - 手动按钮：用面板右上角（齿轮左侧）按钮朗读“当前轮”。
  - 生成中点朗读：应提示“请等回复完成后再朗读”（不播放）。
  - 自动播报：打开 `自动播报新回复`，确认仅在新回复完成后触发。
  - 过滤：打开/关闭 URL/路径/代码过滤，观察读法是否符合预期。

## 5. 已知限制（非代码错误）
- local 引擎 `edge/melo` 需要本机对应的本地 TTS HTTP 服务已启动：
  - edge 默认 `127.0.0.1:5050`
  - melo 默认 `127.0.0.1:5051`
- 如果本地服务不可用，会在测试区/错误提示里明确显示原因；local 模式下也会尝试回退到浏览器语音以避免“完全没声音”。
