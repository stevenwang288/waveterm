# WAVE 改造复现指南（从官方代码恢复到当前状态）

更新时间：2026-02-22  
目标：让任何人/AI **只按本文步骤**，就能把官方仓库的代码恢复到我们当前交付的 WAVE 程序水平（含能打包出同名安装包、关键功能行为一致）。

> 说明：严格“100% 可复现”必须锁定上游的某个 commit/tag。上游“最新”会变化，因此本文固定基线为 `v0.14.0`。

---

## 1) 锁定基线与目标（非常重要）

### 1.1 官方基线（upstream）
- 仓库：`wavetermdev/waveterm`
- 基线：tag `v0.14.0`
- commit：`d42709e8a83b281ca2e4c18b52b9eb0fffa082f0`

### 1.2 我们的目标（WaveCN/WAVE 当前交付）
- 仓库（远端）：`stevenwang288/waveterm`
- 分支：`master`
- 目标提交（commit）：`6ca979e3f4b76d9a02d5b382324ca8eaf2d71b86`
- 版本号：`0.14.0-3`
- Windows 安装包（本机交付落点）：`D:\desk\WAVE-win32-x64-0.14.0-3.exe`

---

## 2) 最快复现（推荐，零分歧）

适用：你只关心“恢复到我们现在这份代码/这份安装包行为”，不要求保留官方仓库的 commit 历史。

1. 克隆我们的仓库：
   - `git clone https://github.com/stevenwang288/waveterm.git`
2. 切到目标分支：
   - `git switch master`
   - `git checkout 6ca979e3f4b76d9a02d5b382324ca8eaf2d71b86`
3. 安装依赖并打包：
   - `npm install`
   - `task package`
4. 产物：
   - `make\WAVE-win32-x64-0.14.0-3.exe`
5. 放到桌面（你机器约定）：
   - 复制到 `D:\desk\WAVE-win32-x64-0.14.0-3.exe`
   - `D:\desk` 只保留这 1 个 WAVE 安装包（不要动桌面其他文件）

---

## 3) 严格从官方仓库起步复现（按文档恢复）

适用：你从 `wavetermdev/waveterm` 开始，按本文把它“恢复到我们现在的状态”。

### 3.1 拉取官方基线
1. 克隆官方仓库：
   - `git clone https://github.com/wavetermdev/waveterm.git`
2. 切到基线版本：
   - `git checkout d42709e8a83b281ca2e4c18b52b9eb0fffa082f0`

### 3.2 引入我们的改造（两种方式二选一）

#### 方式 A：直接检出我们的目标代码（最稳）
1. 添加远端：
   - `git remote add wavecn https://github.com/stevenwang288/waveterm.git`
2. 拉取目标分支：
   - `git fetch wavecn master`
3. 切到目标分支代码：
   - `git switch -c wavecn-master wavecn/master`
   - `git checkout 6ca979e3f4b76d9a02d5b382324ca8eaf2d71b86`
4. 验证版本号：
   - 检查 `package.json` 的 `version` 为 `0.14.0-3`

> 结果：你会得到“与我们交付一致”的代码树；这是严格复现最可靠的方法（对 AI 也最友好）。

#### 方式 B：把改造做成可重放补丁（用于长期维护）
> 这是更“工程化”的做法：把差异做成一组可 cherry-pick/format-patch 的提交。  
> 如果你要走这条路，需要维护者在 `wavecn/master` 上提供：
> - 一组清晰的提交序列（或一个 squashed 提交）
> - 每个提交都对应本文第 4 节的改造点与验收

（当前建议流程）
1. 维护者提供一个 `restore` 分支（基于 upstream `v0.14.0`），并把所有改造整理成线性提交；
2. 你在官方基线分支上执行：`git cherry-pick <提交范围>`

---

## 4) 必须一致的关键行为（验收标准）

### 4.1 终端：只朗读 AI 最终正式回复（不读噪声）
- 终端小喇叭播报内容必须 == “AI 最终正式回复”
- 永不朗读：
  - `Working... (esc to interrupt)`
  - Ctrl+C/Ctrl+D 多次提示（第一次/第二次/…）
  - `again to quit / edit previous message`
  - shell prompt、工具调用提示、状态/进度行、deprecation warning 等

实现线索：
- `frontend/app/block/terminal-speech.ts`
- 单测：`frontend/app/block/tests/terminal-speech-play.test.ts`

### 4.2 终端：右键复制“当前消息”（复制绿色那段整段）
- 右键菜单包含：
  - `复制当前消息`：复制“AI 最终正式回复”（与朗读同源）
  - `复制选中`：仅当有 selection 时出现

实现线索：
- `frontend/app/view/term/term-model.ts`
- i18n 文案：
  - `public/locales/zh-CN/translation.json`
  - `public/locales/en/translation.json`

---

## 5) 复现后的自检（最低限度）

### 5.1 单测（推荐至少跑这个）
- `npm test -- frontend/app/block/tests/terminal-speech-play.test.ts`

### 5.2 打包
- `task package`

### 5.3 人工点检（30 秒）
- 打开终端块运行 `codex`（或任意 AI CLI）：
  - 生成回复后：右键 → `复制当前消息`，粘贴检查不包含 `Working/提示`
  - 点小喇叭：朗读不包含 `Working/提示`

---

## 6) 配套文档索引

- 改造总记录（逐条列出改了什么/为什么/在哪/怎么验收）：  
  - `docs/内部记录/WAVE改造记录_2026-02-22.md`
- 相对上游差异梳理（偏全局）：  
  - `docs/内部记录/差异对比/UPSTREAM_DIFF_ZH.md`
