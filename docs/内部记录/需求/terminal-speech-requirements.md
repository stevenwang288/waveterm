# 终端语音播报需求说明（精细版）

## 1. 背景与目标
本需求只针对终端块（`view=term`）右上角小喇叭功能，不涉及 AI 面板消息列表的播报逻辑。
目标是让语音播报严格等于“AI 最终正式回复”，不读中间过程、不读推理、不读提示词、不读终端噪声。

## 2. 术语定义
- AI 最终正式回复：用户在终端中可见的、最终交付给用户的回答正文。
- 非正式内容：思考过程、状态行、进度、系统提示、命令回显、Prompt 原文、shell 提示符、插件日志。

## 3. 核心行为要求

### 3.1 只播报正式回复
- 必须从终端滚动区提取“最后一条正式回复”。
- 禁止播报以下内容：
  - 用户输入行（例如 `› ...`）
  - 状态栏/百分比/快捷键提示
  - shell prompt（如 `PS C:\...>`）
  - 执行元信息（如 IFLOW `<Execution Info>...</Execution Info>`）
  - 噪声日志（例如 deprecation warning）

### 3.2 模式识别与提取策略
- Codex 风格：优先提取以 `•`/`●` 开头的最后一段 assistant 回复。
- IFLOW 风格：当检测到 execution-info 区块时，允许 plain 文本回退提取，但仍需过滤噪声与非回复行。
- 若无法提取，手动模式可回退到该终端最近一次成功提取的正式回复（仅同终端缓存）。

### 3.3 自动/手动模式
- 自动/手动开关位于终端小喇叭左侧。
- 默认必须是手动（自动关闭）。
- 自动模式开启后：终端完成一次新回复时自动播报一次。
- 自动模式关闭后：必须立即停止当前播放，并取消等待中的自动任务。

### 3.4 终端隔离（关键）
- 自动/手动状态必须按终端块隔离，不能全局联动。
- A 终端开启自动，不得影响 B/C 终端。
- 去重（last spoken）与缓存（last formal reply）也应按终端隔离。

### 3.5 手动播放一致性
- 同一条回复可连续手动点击多次播放，不应出现“第一次可播、第二次失败”。
- 手动点击播放时：若正在播放，再点应停止；停止后可立即再次播放。

### 3.6 自动播放次数与重复控制
- 每条新增正式回复自动仅播报一次。
- 相同回复内容不得重复自动播报（除非用户手动点播）。

### 3.7 语速
- 语速配置范围：0.5x 到 2.0x。
- 语速必须对手动和自动都生效。
- API 音频播放与本地语音回退都应遵守语速。

### 3.8 错误处理
- API 返回非音频内容时，应给出明确错误（如 content-type/配置问题），不要只给泛化报错。
- 本地 provider 下，API 播放失败时应自动回退浏览器语音；仅在双重失败时提示失败。
- 错误提示文案统一、可理解，便于用户定位配置问题。

## 4. 设置面板（齿轮）要求
- 面板紧凑、初始化无滚动条。
- 每个可见项必须有效；无效项删除。
- 自动/手动切换不在设置面板中出现（只保留在终端小喇叭左侧）。
- 避免冗余“状态汇总卡片”信息，减少噪声文案。

## 5. 非目标（本轮不做）
- 不扩展到非终端视图的播报交互重构。
- 不引入与当前目标无关的 CDP/网页自动化路径。

## 6. 验收清单
1. 在终端发起一次 AI 对话，手动点喇叭：只读正式回复。
2. 连续点两次喇叭：都能播放，不报错。
3. 开启自动后再回复一次：自动只播一次。
4. 自动播放过程中关闭自动：立即停播。
5. 同时打开两个终端：A 开自动，B 保持手动；B 不应自动播报。
6. 设置语速 1.25x：手动/自动均明显变快。
7. 人为制造错误 endpoint：提示明确，不是笼统失败。

## 7. 建议实现检查点
- 提取逻辑：`frontend/app/block/terminal-speech.ts`
- 终端 header 交互：`frontend/app/block/blockframe-header.tsx`
- 语音运行时：`frontend/app/aipanel/speechruntime.ts`
- 语音请求层：`frontend/app/aipanel/aispeech.ts`
- 设置面板：`frontend/app/view/waveconfig/speechsettingscontent.tsx`

