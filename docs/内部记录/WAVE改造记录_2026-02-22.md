# WAVE 程序改造记录（从开始到现在，详细版）

更新时间：2026-02-22  
适用仓库：`D:\OneDrive\steven\code\ai\12CLI\waveterm-main`（本机 Windows）  
交付安装包：`D:\desk\WAVE-win32-x64-0.14.0-4.exe`

> 本文目标：把“我们从开始到现在对 WAVE（含本仓自定义分支/本地改造）做过的改造”按模块逐条写清楚：**改了什么、为什么改、怎么实现、在哪个文件、怎么验收**。  
> 其中一条最重要的原则是：**终端朗读/复制只针对 AI 的最终正式回复（你口中的绿色那段），不读 Working/提示/噪声。**
>
> 如果你要“从官方仓库起步”恢复到当前交付状态，请配合阅读：  
> - `docs/内部记录/WAVE改造复现指南_2026-02-22.md`

---

## 0. 范围与术语

### 0.1 本文覆盖范围
- 覆盖本仓自定义/本地改造（含中文化、侧边栏工作流、终端交互、语音播报链路、健壮性修复、打包交付等）。
- 同时记录“你明确提出过但目前仍未完成/待修”的事项，避免遗漏（见第 5 节）。

### 0.2 关键术语（和你口径对齐）
- **AI 最终正式回复**：你认为“绿色背景”的那段——也就是对用户真正交付的回答正文。
  - 在 Codex TUI 类界面里，它通常以 `•` / `●` 的 bullet 段落呈现（并对应绿底样式）；  
  - 在 WAVE 的终端块里，它表现为终端输出中的“assistant 最终回答段落”，我们用提取规则去抓这段。
- **噪声/非正式内容**：`Working... (esc to interrupt)`、Ctrl+C 多次提示、footer 快捷键提示、shell prompt、命令回显、工具调用提示、进度/状态行、deprecation warning 等——这些都**不得**被朗读/复制当作“当前消息”。

---

## 1. 基线、版本号与交付策略

### 1.1 上游基线与差异梳理
- 本仓与上游 `wavetermdev/waveterm` 的整体差异梳理，已有单独文档：  
  - `docs/内部记录/差异对比/UPSTREAM_DIFF_ZH.md`

### 1.2 版本号策略（解决你说的“版本号区分不开”）
- Windows 安装包版本采用 `0.14.0-<patch>` 递增：
  - `0.14.0-1` → `0.14.0-2` → `0.14.0-3` → `0.14.0-4`
- 目的：
  - 每次交付一个“你能安装验证”的明确版本；
  - 避免多个安装包名字/版本混在一起，难以回滚/对比。

### 1.3 交付落点（你固定工作流）
- 你的 Windows 桌面目录固定为：`D:\desk`（你称 “DESK”）。
- 每次交付后：`D:\desk` 仅保留 1 个最新的 WAVE 安装包（不动桌面其他文件）。

---

## 2. 改造清单（按模块逐条）

### 2.1 语音播报（Speech）体系改造

#### 2.1.1 Speech 设置面板（WaveConfig → Speech）
**背景问题**
- 早期面板信息杂乱、入口不可用/灰色“点不动”，导致你无法判断是“配置错”还是“播放链路坏”。

**改造目标**
- 让 Speech 配置、测试、自动/手动行为可控、可验收。

**主要改造点**
- 新增/收拢 Speech 配置项（按区块组织）：
  - `总开关`
  - `自动播报新回复` / `手动按钮显示`
  - `语音来源`：local / OpenAI 兼容 API
  - `API 设置`：Endpoint / Model
  - `本地引擎`：browser / edge / melo
  - `本地模型（Melo）`：目录扫描 / 模型名
  - `角色人物（voice）`：assistant / user / system
  - `播报过滤`：URL/路径/代码过滤
  - `测试朗读`：输入文本 + 角色选择 + 播放/停止（用于快速验证链路）
- 修复“朗读按钮灰色点不动”：
  - 不再因为“无文本/开关关闭”而直接禁用；点击后给出明确错误提示（可定位问题）。

**实现位置**
- 设置面板：`frontend/app/view/waveconfig/speechsettingscontent.tsx`
- 语音设置解析：`frontend/app/aipanel/speechsettings.ts`
- 语音运行时统一封装：`frontend/app/aipanel/speechruntime.ts`

**阶段记录**
- `docs/内部记录/阶段状态/WAVE_SPEECH_AND_UI_STATUS_2026-02-15.md`
- `docs/内部记录/阶段状态/WAVE_SPEECH_AND_UI_STATUS_2026-02-16.md`

---

#### 2.1.2 终端块朗读：只朗读“最终正式回复”（绿底那段）
**背景问题（你反复强调的痛点）**
- 终端朗读经常会把 “Working/esc 中断”、Ctrl+C 多次提示、footer 提示等读出来；
- 你要的是：**只播报 AI 的正式回复**，其他都不读。

**改造目标（严格口径）**
- 终端右上角小喇叭：播报内容 == “AI 最终正式回复”。
- 任何 status/hint/working/提示行：**0 概率被读到**。

**核心实现策略（面向 Codex/类似 TUI）**
- 当检测到 Codex UI 特征时：
  - **只接受**以 `•`/`●` 开头的最后一段 assistant 回复；
  - **不再回退**到“纯文本快照”去猜（避免把 footer/status 当回复读出来）。
- 对提取到的段落进行噪声过滤：
  - 永不朗读：`Working...`、`esc to interrupt`、Ctrl+C/Ctrl+D 多次/序号提示、`again to quit / edit previous message`、node deprecation 等。
- 增加“prompt 边界”校验（避免半截/未完成回复）：
  - 严格模式：必须在 assistant 回复后看到下一条用户 prompt 才算“完成的一轮”；
  - 放宽模式：用于手动兜底（仍只读正式回复，不读提示）。

**实现位置**
- 提取/过滤逻辑：`frontend/app/block/terminal-speech.ts`
- 单测覆盖：`frontend/app/block/tests/terminal-speech-play.test.ts`

**验收方式**
- 运行单测（已通过）：`vitest frontend/app/block/tests/terminal-speech-play.test.ts`
- 人工验收要点：
  - 朗读/复制不会包含 `Working...` / Ctrl+C 提示 / footer hints。

---

#### 2.1.3 终端右键新增：复制“当前消息”（= 绿色那段整段）
**你提出的具体需求**
- 你要能像我刚才发给你的那段“绿色回复”一样，一键复制整段：
  - 右键菜单：`复制当前消息`
  - 以及：`复制选中`

**改造内容**
- 终端视图右键菜单新增两类复制：
  1) **复制选中**：当终端有 selection 时出现；
  2) **复制当前消息**：无论是否选中都可用，复制的内容来源于“终端正式回复提取器”，与朗读同源。
- 复制成功/失败反馈：
  - 成功：通知提示 `已复制`
  - 没有可复制的正式回复：提示 `没有检测到可复制的 AI 正式回复`

**实现位置**
- 终端右键菜单构建：`frontend/app/view/term/term-model.ts`
  - 使用：`getLatestTerminalFormalReplyText()`（来自 `frontend/app/block/terminal-speech.ts`）
  - 使用通知：`pushNotification()`（来自 `frontend/app/store/global.ts`）
- 文案：
  - `public/locales/zh-CN/translation.json`
  - `public/locales/en/translation.json`

**交付版本**
- 已打进 `0.14.0-4` 安装包：`D:\desk\WAVE-win32-x64-0.14.0-4.exe`

---

### 2.2 终端显示/渲染稳定性：修复“显示不完整/只剩一小块”

**现象**
- 终端在某些 AI CLI 全屏 UI（alternate screen）场景，出现内容被挤没/只剩一小块的错乱。

**根因**
- OSC 16162 收到 `R`（reset/ready）事件时，曾经无条件退出 alternate screen（`ESC[?1049l`）。
- AI CLI 常驻使用 alternate screen，无条件退出会造成 UI 状态错乱。

**修复策略**
- 仅对非 AI 命令退出 alternate screen；如果上一条命令是 AI CLI（codex/claude/gemini/...），则跳过退出。

**实现位置**
- `frontend/app/view/term/osc-handlers.ts`

**阶段记录**
- `docs/内部记录/阶段状态/WAVE_UI_DISPLAY_INCOMPLETE_ROOTCAUSE_2026-02-16.md`

---

### 2.3 配置健壮性：修复 JSON BOM / UTF-16 导致的“配置错误态”

**现象**
- Windows 上某些写文件方式会产生 UTF-8 BOM 或 UTF-16，导致 Go `encoding/json` 解析失败；
- 进入“配置错误态”后 UI 会出现灰/不可用等连锁问题。

**修复策略**
- Go 侧读取设置时：兼容 UTF-8 BOM、UTF-16LE/BE 解码；
- Electron main 启动读取时：剥离 `\uFEFF`；
- Smoke 脚本输出避免 BOM。

**实现位置**
- `pkg/wconfig/settingsconfig.go`
- `emain/launchsettings.ts`
- `scripts/smoke-waveai-tts-win.ps1`

**阶段记录**
- `docs/内部记录/阶段状态/WAVE_CONFIG_BOM_FIX_2026-02-16.md`

---

### 2.4 工作区与侧边栏工作流改造（收藏/服务器/布局/Git/AI）

> 这一块是“长期工作流效率”的核心改造：把高频能力收进统一侧边栏/侧面板，并补齐右键菜单。

#### 2.4.1 顶部按钮与面板交互统一
- 顶部按钮顺序固定：`AI -> 收藏 -> 服务器 -> 布局 -> Git`
- `AI / 收藏 / 服务器 / Git` 统一为“左侧活动栏 + 右侧展开面板”交互，不再各自一套。
- 移除“标签页下方单独收藏横条”（避免重复入口/占空间）。

实现线索（总入口）
- 工作区 widgets 与面板：`frontend/app/workspace/widgets.tsx`
- 右侧侧边栏聚合：`frontend/app/workspace/right-sidebar.tsx`

#### 2.4.2 服务器面板（Servers Panel）
- 列出本地/远程连接
- 添加服务器（host/user/port），可选立即连接
- 打开连接配置编辑器、刷新/重试

实现位置
- `frontend/app/workspace/servers-panel.tsx`

#### 2.4.3 收藏（Favorites）
- 右键菜单支持：打开终端、打开文件管理器、复制完整路径、应用到当前终端、自动命令等
- 收藏全局存储（不绑定 tab），远程收藏记录 `connection + path`

实现位置
- `frontend/app/store/favorites-model.ts`
- `frontend/app/workspace/favorites.tsx`
- `frontend/app/workspace/favorites-bar.tsx`

#### 2.4.4 布局侧面板（分屏预设 + 保存/恢复）
- 一键 2/3/4/6/8/9 分屏
- 保存/恢复布局（每格路径 + 启动命令）

实现线索
- `frontend/util/clilayout.ts`
- 相关 UI（布局侧边栏/入口）：见 `frontend/app/workspace/*` 与 `frontend/app/view/term/term-model.ts` 的“加入布局”菜单

#### 2.4.5 Git 面板
- Git 入口改为统一侧面板，不再“突兀弹层/新终端块”
- 文案乱码自检清理

实现线索
- `frontend/app/workspace/git-panel.tsx`

#### 2.4.6 通知气泡（右下角堆叠提示）
- 终端响铃/未读时右下角提示；点击跳转到对应 tab + 分屏，并清除未读

实现线索
- 终端 bell 通知：`frontend/app/view/term/termwrap.ts`
- 通知 UI：`frontend/app/notification/*`

对应清单（已做项）
- `docs/内部记录/待办/USER_TODO_ZH.md`

---

### 2.5 终端交互细化（滚动/切换/快捷键/右键菜单）

#### 2.5.1 滚轮/逐行滚动
- `fastScrollSensitivity=1` 让滚轮不再飞快
- 新增 `term:wheellinescroll`（默认 true）：鼠标滚轮逐行滚动；触控板保留平滑
- 方向键 `↑/↓`：当“已滚动离底部”时滚动 1 行；在底部时不抢 TUI/命令行行为

对应清单
- `docs/内部记录/待办/USER_TODO_ZH.md`

#### 2.5.2 Tab 切换与 Windows Alt+数字
- 分屏焦点循环：
  - `Ctrl+Tab` / `Ctrl+Shift+Tab`
  - `Tab` / `Shift+Tab`（在可安全拦截场景启用）
- Windows `Alt+1..9` 切 tab：主进程拦截并 reinject，规避 OS/IME 吞键

对应清单
- `docs/内部记录/待办/USER_TODO_ZH.md`

#### 2.5.3 终端右键菜单增强
- 增加“用指定 AI 打开”子菜单（codex/claude/gemini/amp/iflow/opencode 等）
- 终端右键可加入布局/收藏/翻译/打开 URL 等

实现线索
- 终端右键菜单：`frontend/app/view/term/term-model.ts`

---

### 2.6 i18n 中文化（前端/主进程）

**目标**
- 所有用户可见文案进入 i18n 资源，提供 `zh-CN` 翻译，减少硬编码英文。

实现线索
- 前端 i18n：`frontend/app/i18n.ts`
- 语言包：
  - `public/locales/zh-CN/translation.json`
  - `public/locales/en/translation.json`
- 主进程菜单 i18n：`emain/i18n-main.ts`
- 可见文案扫描脚本：`scripts/i18n-scan-visible.cjs`

---

### 2.7 构建/打包/交付流程

#### 2.7.1 Windows 打包与快速回归
- 打包：`task package`（产物在 `make/`）
- 推荐 smoke：`scripts/smoke-win.ps1`
- 2–3 分钟 UI 回归清单：见文档  
  - `docs/内部记录/构建与验证/Windows回归验证.md`

#### 2.7.2 Linux 构建/安装
- 说明文档：`docs/内部记录/构建与验证/Linux构建安装.md`

---

## 3. 时间线（按日期/阶段）

### 2026-02-15
- Speech 设置面板初版收口、语音运行时统一封装
- 安装包产物：`0.14.0-1`
- 终端主题/交互评估与收口记录  
  - `docs/内部记录/阶段状态/WAVE_版本功能与侧边栏评估_2026-02-15.md`

### 2026-02-16
- Speech 设置面板重构（分区+测试朗读）
- 修复“朗读按钮灰色点不动”
- 修复 OSC alternate screen 导致的“显示不完整”
- 修复配置 JSON BOM/UTF-16 兼容

### 2026-02-20 ~ 2026-02-21
- 明确“终端朗读需求说明（精细版）”并形成验收清单：  
  - `docs/内部记录/需求/terminal-speech-requirements.md`

### 2026-02-22
- 终端朗读提取规则加固：**只朗读最终正式回复**，屏蔽 Working/提示/噪声（并补齐单测）
- 修复 Codex 状态行前缀包含 spinner（如 `⠋ Working ...`）时被误判为正式回复的问题
- 终端右键菜单新增：`复制当前消息`（复制绿色那段整段）
- 交付安装包：`D:\desk\WAVE-win32-x64-0.14.0-4.exe`
- docs 目录整理：内部记录归档到 `docs/内部记录/`

---

## 4. 验收/自检清单（按你现场用法）

### 4.1 复制/朗读准确性（核心）
- 打开一个终端块，运行 `codex` 产出回复：
  - 右键 → `复制当前消息`：应只复制正式回复（不含 Working/提示）
  - 点喇叭：应只朗读正式回复（不含 Working/提示）
- 复制/朗读遇到无正式回复：
  - 应提示 `没有检测到可复制的 AI 正式回复`（不应复制/朗读杂音）

### 4.2 分屏/面板工作流（高频）
- 布局侧边栏：2/3/4/6/8/9 分屏、保存/恢复
- 服务器面板：连接列表、添加、编辑
- 收藏：右键菜单项可用
- 通知气泡：终端 bell 后右下角提示，点击跳转

---

## 5. 仍未完成 / 待修（你明确提出过）

> 这一节是“你提过、但现在还没闭环”的列表（不装没看到），后续按优先级逐个收口。

### 5.1 终端标题/工作路径显示不一致（你截图红框）
- 现象：终端实际 cwd 在 A，但标题/标签显示跳回 B。
- 状态：未彻底定位与修复（需要追踪谁在写 `cmd:cwd` / 何时被清空/覆盖）。

### 5.2 未读提示改造（颜色逻辑改为按钮）
- 你想要：在“自动”左侧新增一个按钮 `未读`；有未读时变橙黄；聚焦后恢复正常。
- 状态：未合入（之前做过原型但未收口）。

### 5.3 Alt+W 关闭窗口
- 你要求：释放 `Alt+W`，不能关闭窗口。
- 状态：未处理。

### 5.4 分屏滚动不自动到最新
- 现象：有时新消息不在最底部，需要滚很久才能到最新。
- 状态：未处理。

### 5.5 上游同步与推送远端仓库
- 你要求：跟上游更新到最新、推送到你的在线仓库。
- 状态：未完成（需要明确 upstream remote、合并策略、冲突处理与验证）。

（更多历史待办请参考）
- `docs/内部记录/待办/USER_TODO_ZH.md`
- `docs/内部记录/待办/待开发.md`

---

## 6. 快速定位索引（改哪里找哪里）

### 语音播报/提取
- `frontend/app/block/terminal-speech.ts`
- `frontend/app/block/tests/terminal-speech-play.test.ts`
- `frontend/app/aipanel/speechruntime.ts`
- `frontend/app/aipanel/aispeech.ts`
- `frontend/app/view/waveconfig/speechsettingscontent.tsx`

### 终端右键菜单/复制当前消息
- `frontend/app/view/term/term-model.ts`
- `public/locales/zh-CN/translation.json`

### 终端显示/OSC
- `frontend/app/view/term/osc-handlers.ts`

### 配置 BOM/UTF-16
- `pkg/wconfig/settingsconfig.go`
- `emain/launchsettings.ts`

### 工作区面板/侧边栏
- `frontend/app/workspace/widgets.tsx`
- `frontend/app/workspace/servers-panel.tsx`
- `frontend/app/workspace/favorites.tsx`
- `frontend/app/workspace/git-panel.tsx`
